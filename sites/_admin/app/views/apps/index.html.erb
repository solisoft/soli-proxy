<!-- Header -->
<div class="mb-6">
    <p class="text-sm text-slate-400">Manage application deployments. Blue/green slots enable zero-downtime releases.</p>
</div>

<!-- App Grid -->
<div id="apps-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <div class="bg-slate-900/60 border border-white/5 rounded-xl p-8 text-center col-span-full">
        <span class="text-slate-500">Loading applications...</span>
    </div>
</div>

<script>
var AppManager = {
    load: function() {
        AdminAPI.getApps().then(function(d) {
            AppManager.render(d.data);
        }).catch(function() {
            document.getElementById('apps-grid').innerHTML =
                '<div class="bg-slate-900/60 border border-white/5 rounded-xl p-8 text-center col-span-full">' +
                '<span class="text-rose-400">Failed to load applications</span></div>';
        });
    },

    render: function(apps) {
        var grid = document.getElementById('apps-grid');
        if (!apps || !apps.length) {
            grid.innerHTML = '<div class="bg-slate-900/60 border border-white/5 rounded-xl p-8 text-center col-span-full">' +
                '<span class="text-slate-500">No applications found</span></div>';
            return;
        }

        grid.innerHTML = apps.map(function(app) {
            var cfg = app.config || {};
            var name = cfg.name || cfg.domain || 'unknown';
            var currentSlot = app.current_slot || '-';
            var blueStatus = app.blue ? (app.blue.status || 'Stopped') : 'N/A';
            var greenStatus = app.green ? (app.green.status || 'Stopped') : 'N/A';
            var bluePort = app.blue && app.blue.port ? app.blue.port : '-';
            var greenPort = app.green && app.green.port ? app.green.port : '-';
            var domain = cfg.domain || '';
            var appPath = app.path || '';

            function slotBadge(status) {
                var s = status.toLowerCase();
                if (s === 'running') return 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20';
                if (s === 'stopped') return 'bg-slate-500/10 text-slate-400 border-slate-500/20';
                return 'bg-amber-500/10 text-amber-400 border-amber-500/20';
            }

            return '<div class="bg-slate-900/60 border border-white/5 rounded-xl overflow-hidden">' +
                '<div class="p-5">' +
                    '<div class="flex items-center justify-between mb-4">' +
                        '<div>' +
                            '<h3 class="text-base font-semibold text-white">' + AdminAPI.esc(name) + '</h3>' +
                            (domain ? '<div class="text-xs text-slate-500 font-mono mt-0.5">' + AdminAPI.esc(domain) + '</div>' : '') +
                            (appPath ? '<div class="text-xs text-slate-600 font-mono">' + AdminAPI.esc(appPath) + '</div>' : '') +
                        '</div>' +
                        '<span class="px-2.5 py-1 rounded-full text-xs font-medium border ' + (currentSlot === 'blue' ? 'bg-blue-500/10 text-blue-400 border-blue-500/20' : 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20') + '">' + AdminAPI.esc(currentSlot) + '</span>' +
                    '</div>' +

                    '<!-- Slots -->' +
                    '<div class="grid grid-cols-2 gap-3 mb-4">' +
                        '<div class="bg-slate-800/50 rounded-lg p-3">' +
                            '<div class="flex items-center justify-between mb-1">' +
                                '<span class="text-xs font-medium text-blue-400">Blue</span>' +
                                '<span class="px-1.5 py-0.5 rounded text-[10px] font-medium border ' + slotBadge(blueStatus) + '">' + AdminAPI.esc(blueStatus) + '</span>' +
                            '</div>' +
                            '<div class="text-xs text-slate-500 font-mono">' + (bluePort && bluePort !== '-' && bluePort !== 0 ? ':' + bluePort : 'not assigned') + '</div>' +
                        '</div>' +
                        '<div class="bg-slate-800/50 rounded-lg p-3">' +
                            '<div class="flex items-center justify-between mb-1">' +
                                '<span class="text-xs font-medium text-emerald-400">Green</span>' +
                                '<span class="px-1.5 py-0.5 rounded text-[10px] font-medium border ' + slotBadge(greenStatus) + '">' + AdminAPI.esc(greenStatus) + '</span>' +
                            '</div>' +
                            '<div class="text-xs text-slate-500 font-mono">' + (greenPort && greenPort !== '-' && greenPort !== 0 ? ':' + greenPort : 'not assigned') + '</div>' +
                        '</div>' +
                    '</div>' +

                    '<!-- Actions -->' +
                    '<div class="flex flex-wrap gap-2">' +
                        '<button onclick="AppManager.action(\'' + AdminAPI.esc(name) + '\', \'deploy\')" class="px-3 py-1.5 bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 text-xs font-medium rounded-lg transition-colors border border-emerald-500/20">Deploy</button>' +
                        '<button onclick="AppManager.action(\'' + AdminAPI.esc(name) + '\', \'restart\')" class="px-3 py-1.5 bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-400 text-xs font-medium rounded-lg transition-colors border border-indigo-500/20">Restart</button>' +
                        '<button onclick="AppManager.action(\'' + AdminAPI.esc(name) + '\', \'rollback\')" class="px-3 py-1.5 bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 text-xs font-medium rounded-lg transition-colors border border-amber-500/20">Rollback</button>' +
                        '<button onclick="AppManager.action(\'' + AdminAPI.esc(name) + '\', \'stop\')" class="px-3 py-1.5 bg-rose-500/10 hover:bg-rose-500/20 text-rose-400 text-xs font-medium rounded-lg transition-colors border border-rose-500/20">Stop</button>' +
                        '<button onclick="AppManager.showLogs(\'' + AdminAPI.esc(name) + '\')" class="px-3 py-1.5 bg-slate-500/10 hover:bg-slate-500/20 text-slate-400 text-xs font-medium rounded-lg transition-colors border border-slate-500/20">Logs</button>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }).join('');
    },

    action: function(name, action) {
        AdminAPI.appAction(name, action).then(function(d) {
            AdminAPI.toast(d.data.message || (action + ' started'), 'success');
            setTimeout(function() { AppManager.load(); }, 1000);
        }).catch(function(err) {
            AdminAPI.toast('Failed: ' + err.message, 'error');
        });
    },

    showLogs: function(name) {
        AdminAPI.getAppLogs(name).then(function(d) {
            var logs = d.data;
            var html = '<div class="p-6">' +
                '<h2 class="text-lg font-semibold text-white mb-4">Logs: ' + AdminAPI.esc(name) + '</h2>' +
                '<div class="space-y-3">' +
                    '<div><h3 class="text-xs font-medium text-blue-400 mb-1">Blue Slot</h3>' +
                    '<pre class="bg-slate-950 rounded-lg p-3 text-xs text-slate-300 font-mono max-h-48 overflow-auto whitespace-pre-wrap">' + AdminAPI.esc(logs.blue || 'No logs') + '</pre></div>' +
                    '<div><h3 class="text-xs font-medium text-emerald-400 mb-1">Green Slot</h3>' +
                    '<pre class="bg-slate-950 rounded-lg p-3 text-xs text-slate-300 font-mono max-h-48 overflow-auto whitespace-pre-wrap">' + AdminAPI.esc(logs.green || 'No logs') + '</pre></div>' +
                '</div>' +
                '<div class="mt-4"><button onclick="AdminAPI.closeModal()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm font-medium rounded-lg transition-colors border border-white/10">Close</button></div>' +
            '</div>';
            AdminAPI.showModal(html);
        }).catch(function(err) {
            AdminAPI.toast('Failed to load logs: ' + err.message, 'error');
        });
    }
};

AppManager.load();
setInterval(function() { AppManager.load(); }, 10000);
</script>
