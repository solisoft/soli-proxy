<!-- Header -->
<div class="flex items-center justify-between mb-6">
    <p class="text-sm text-slate-400">Manage application deployments</p>
</div>

<!-- App Grid -->
<div id="apps-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <div class="bg-slate-900/60 border border-white/5 rounded-xl p-8 text-center col-span-full">
        <span class="text-slate-500">Loading applications...</span>
    </div>
</div>

<script>
var AppMetrics = {};

var AppManager = {
    load: function() {
        Promise.all([
            AdminAPI.getApps(),
            AdminAPI.getAllAppMetrics()
        ]).then(function(results) {
            var apps = results[0].data;
            AppMetrics = results[1].data || {};
            AppManager.render(apps);
        }).catch(function() {
            document.getElementById('apps-grid').innerHTML =
                '<div class="bg-slate-900/60 border border-white/5 rounded-xl p-8 text-center col-span-full">' +
                '<span class="text-rose-400">Failed to load applications</span></div>';
        });
    },

    render: function(apps) {
        var grid = document.getElementById('apps-grid');
        if (!apps || !apps.length) {
            grid.innerHTML = '<div class="bg-slate-900/60 border border-white/5 rounded-xl p-8 text-center col-span-full">' +
                '<div class="text-slate-500 mb-2">No applications</div>' +
                '<div class="text-xs text-slate-600">Applications are discovered from the sites/ directory</div></div>';
            return;
        }

        grid.innerHTML = apps.map(function(app) {
            var cfg = app.config || {};
            var name = cfg.name || cfg.domain || 'unknown';
            var currentSlot = app.current_slot || '-';
            var blueStatus = app.blue ? (app.blue.status || 'stopped') : 'stopped';
            var greenStatus = app.green ? (app.green.status || 'stopped') : 'stopped';
            var bluePort = app.blue && app.blue.port ? app.blue.port : 0;
            var greenPort = app.green && app.green.port ? app.green.port : 0;
            var domain = cfg.domain || '';

            var metrics = AppMetrics[name] || {};
            var reqs = metrics.requests || 0;
            var errors = metrics.errors || 0;
            var avgTime = metrics.avg_response_time_ms || 0;

            var testDomain = '';
            if (domain && !domain.endsWith('.test') && !domain.endsWith('.localhost')) {
                var lastDot = domain.lastIndexOf('.');
                if (lastDot > 0) {
                    testDomain = domain.substring(0, lastDot) + '.test';
                }
            }
            var hasTestDomain = testDomain !== '';

            var errorRate = reqs > 0 ? ((errors / reqs) * 100).toFixed(1) : 0;

            // Determine overall health
            var anyRunning = blueStatus.toLowerCase() === 'running' || greenStatus.toLowerCase() === 'running';
            var anyStarting = blueStatus.toLowerCase() === 'starting' || greenStatus.toLowerCase() === 'starting';
            var healthLabel, healthColor, healthBg, healthBorder, healthDot;
            if (anyRunning && errorRate < 5) {
                healthLabel = 'Healthy'; healthColor = 'text-emerald-400'; healthBg = 'bg-emerald-500/10'; healthBorder = 'border-emerald-500/20'; healthDot = 'bg-emerald-400';
            } else if (anyStarting) {
                healthLabel = 'Starting'; healthColor = 'text-blue-400'; healthBg = 'bg-blue-500/10'; healthBorder = 'border-blue-500/20'; healthDot = 'bg-blue-400';
            } else if (anyRunning && errorRate >= 5) {
                healthLabel = 'Degraded'; healthColor = 'text-amber-400'; healthBg = 'bg-amber-500/10'; healthBorder = 'border-amber-500/20'; healthDot = 'bg-amber-400';
            } else {
                healthLabel = 'Stopped'; healthColor = 'text-slate-500'; healthBg = 'bg-slate-500/10'; healthBorder = 'border-slate-500/20'; healthDot = 'bg-slate-500';
            }

            function statusDot(status) {
                var s = status.toLowerCase();
                if (s === 'running') return 'bg-emerald-400';
                if (s === 'starting') return 'bg-blue-400';
                if (s === 'stopped') return 'bg-slate-600';
                return 'bg-amber-400';
            }

            function statusText(status) {
                var s = status.toLowerCase();
                if (s === 'running') return 'text-emerald-400';
                if (s === 'starting') return 'text-blue-400';
                if (s === 'stopped') return 'text-slate-500';
                return 'text-amber-400';
            }

            function formatNum(n) {
                if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
                if (n >= 1000) return (n/1000).toFixed(1) + 'k';
                return n.toString();
            }

            return '<div class="bg-slate-900/60 border border-white/5 rounded-xl overflow-hidden">' +

                // Card header
                '<div class="px-5 pt-6 pb-4">' +
                    '<div class="flex items-center justify-between mb-3">' +
                        '<div class="min-w-0">' +
                            '<h3 class="text-sm font-semibold text-white truncate">' + AdminAPI.esc(name) + '</h3>' +
                            '<div class="flex items-center gap-2 mt-0.5 text-xs">' +
                                (domain ? '<span class="text-slate-500 font-mono truncate">' + AdminAPI.esc(domain) + '</span>' : '') +
                                (hasTestDomain ? '<a href="http://' + AdminAPI.esc(testDomain) + '" target="_blank" class="shrink-0 text-indigo-400 hover:text-indigo-300 transition-colors">dev</a>' : '') +
                            '</div>' +
                        '</div>' +
                        '<span class="shrink-0 flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border ' + healthBg + ' ' + healthColor + ' ' + healthBorder + '">' +
                            '<span class="w-1.5 h-1.5 rounded-full ' + healthDot + '"></span>' +
                            healthLabel +
                        '</span>' +
                    '</div>' +
                '</div>' +

                // Metrics row
                '<div class="px-5 pb-4">' +
                    '<div class="flex gap-3">' +
                        '<div class="flex-1 bg-slate-800/50 rounded-lg p-3 text-center">' +
                            '<div class="text-lg font-bold text-white">' + formatNum(reqs) + '</div>' +
                            '<div class="text-xs text-slate-500">Requests</div>' +
                        '</div>' +
                        '<div class="flex-1 bg-slate-800/50 rounded-lg p-3 text-center">' +
                            '<div class="text-lg font-bold ' + (avgTime < 100 ? 'text-emerald-400' : avgTime < 500 ? 'text-amber-400' : 'text-rose-400') + '">' + (avgTime > 0 && avgTime < 1 ? Math.round(avgTime * 1000) + '<span class="text-xs font-normal text-slate-500">\u00b5s</span>' : Math.round(avgTime) + '<span class="text-xs font-normal text-slate-500">ms</span>') + '</div>' +
                            '<div class="text-xs text-slate-500">Avg Time</div>' +
                        '</div>' +
                        '<div class="flex-1 bg-slate-800/50 rounded-lg p-3 text-center">' +
                            '<div class="text-lg font-bold ' + (errors > 0 ? 'text-rose-400' : 'text-slate-500') + '">' + formatNum(errors) + '</div>' +
                            '<div class="text-xs text-slate-500">Errors</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +

                // Deployment slots
                '<div class="px-5 py-4">' +
                    '<div class="grid grid-cols-2 gap-3">' +
                        '<div class="flex items-center gap-2 px-3 py-3 rounded-lg ' + (currentSlot === 'blue' ? 'bg-blue-500/5 border border-blue-500/20' : 'bg-slate-800/30') + '">' +
                            '<span class="w-2 h-2 rounded-full ' + statusDot(blueStatus) + '"></span>' +
                            '<div class="min-w-0">' +
                                '<div class="text-xs font-medium ' + (currentSlot === 'blue' ? 'text-blue-400' : 'text-slate-400') + '">Blue' + (currentSlot === 'blue' ? ' <span class="text-blue-500/60">active</span>' : '') + '</div>' +
                                '<div class="text-xs ' + statusText(blueStatus) + '">' + blueStatus + (bluePort ? ' :' + bluePort : '') + '</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="flex items-center gap-2 px-3 py-3 rounded-lg ' + (currentSlot === 'green' ? 'bg-emerald-500/5 border border-emerald-500/20' : 'bg-slate-800/30') + '">' +
                            '<span class="w-2 h-2 rounded-full ' + statusDot(greenStatus) + '"></span>' +
                            '<div class="min-w-0">' +
                                '<div class="text-xs font-medium ' + (currentSlot === 'green' ? 'text-emerald-400' : 'text-slate-400') + '">Green' + (currentSlot === 'green' ? ' <span class="text-emerald-500/60">active</span>' : '') + '</div>' +
                                '<div class="text-xs ' + statusText(greenStatus) + '">' + greenStatus + (greenPort ? ' :' + greenPort : '') + '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +

                // Action bar
                '<div class="flex items-center border-t border-white/5 divide-x divide-white/5">' +
                    '<button data-app="' + AdminAPI.esc(name) + '" data-action="deploy" data-loading-text="Deploying..." onclick="AppManager.action(\'' + AdminAPI.esc(name) + '\', \'deploy\', this)" class="flex-1 px-3 py-2.5 text-xs font-medium text-emerald-400 hover:bg-emerald-500/5 transition-colors">Deploy</button>' +
                    '<button data-app="' + AdminAPI.esc(name) + '" data-action="restart" data-loading-text="Restarting..." onclick="AppManager.action(\'' + AdminAPI.esc(name) + '\', \'restart\', this)" class="flex-1 px-3 py-2.5 text-xs font-medium text-slate-400 hover:bg-white/5 transition-colors">Restart</button>' +
                    '<button data-app="' + AdminAPI.esc(name) + '" data-action="stop" data-loading-text="Stopping..." onclick="AppManager.action(\'' + AdminAPI.esc(name) + '\', \'stop\', this)" class="flex-1 px-3 py-2.5 text-xs font-medium text-rose-400 hover:bg-rose-500/5 transition-colors">Stop</button>' +
                    '<button onclick="AppManager.showLogs(\'' + AdminAPI.esc(name) + '\')" class="flex-1 px-3 py-2.5 text-xs font-medium text-slate-400 hover:bg-white/5 transition-colors">Logs</button>' +
                '</div>' +

            '</div>';
        }).join('');

        AppManager.scheduleRefresh();
    },

    scheduleRefresh: function() {
        if (AppManager.refreshTimeout) {
            clearTimeout(AppManager.refreshTimeout);
        }
        AppManager.refreshTimeout = setTimeout(function() {
            AppManager.load();
        }, 10000);
    },

    action: function(name, action, btn) {
        if (btn) AdminAPI.setButtonLoading(btn, true);
        AdminAPI.appAction(name, action).then(function(d) {
            AdminAPI.toast(d.data.message || (action + ' started'), 'success');
            setTimeout(function() { AppManager.load(); }, 1500);
        }).catch(function(err) {
            AdminAPI.toast('Failed: ' + err.message, 'error');
            if (btn) AdminAPI.setButtonLoading(btn, false);
        });
    },

    showLogs: function(name) {
        AdminAPI.getAppLogs(name).then(function(d) {
            var logs = d.data;
            var html = '<div class="p-6">' +
                '<h2 class="text-lg font-semibold text-white mb-4">Logs: ' + AdminAPI.esc(name) + '</h2>' +
                '<div class="space-y-3">' +
                    '<div><h3 class="text-xs font-medium text-blue-400 mb-1">Blue</h3>' +
                    '<pre class="bg-slate-950 rounded-lg p-3 text-xs text-slate-300 font-mono max-h-48 overflow-auto">' + AdminAPI.esc(logs.blue || 'No logs') + '</pre></div>' +
                    '<div><h3 class="text-xs font-medium text-emerald-400 mb-1">Green</h3>' +
                    '<pre class="bg-slate-950 rounded-lg p-3 text-xs text-slate-300 font-mono max-h-48 overflow-auto">' + AdminAPI.esc(logs.green || 'No logs') + '</pre></div>' +
                '</div>' +
                '<div class="mt-4"><button onclick="AdminAPI.closeModal()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm rounded-lg transition-colors">Close</button></div>' +
            '</div>';
            AdminAPI.showModal(html);
        }).catch(function(err) {
            AdminAPI.toast('Failed to load logs: ' + err.message, 'error');
        });
    }
};

AppManager.load();
</script>
